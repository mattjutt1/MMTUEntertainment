# Security Plan - MMTU Entertainment

## Executive Summary
This monorepo requires immediate security hardening to protect revenue-generating experiments and customer data. Critical findings include exposed secrets in build artifacts and lack of automated security scanning.

## Threat Model

### Primary Assets
1. **Customer Payment Data** - Stripe integration for $9-$199 pricing
2. **Feature Flag System** - Controls revenue experiments  
3. **Analytics Events** - PostHog tracking with PII considerations
4. **GitHub App Secrets** - DriftGuard marketplace credentials

### Attack Vectors
- **Supply Chain**: 62K+ JS files with unmonitered dependencies
- **Secrets Exposure**: API keys in committed build artifacts
- **Injection Points**: Unvalidated user inputs in pricing/bundle flows
- **Authorization Gaps**: Feature flag manipulation without gatekeeper

## Day-0 Guardrails

### Immediate Actions Required
1. **Remove Secrets from Git**
   ```bash
   git rm -r --cached _archive/mmtu-site-2025-08-13_2230/.next/
   echo ".next/" >> .gitignore
   git commit -m "Remove Next.js build artifacts with secrets"
   ```

2. **Install Pre-commit Hooks**
   ```bash
   pip install pre-commit detect-secrets
   detect-secrets scan > .secrets.baseline
   pre-commit install
   ```

3. **Enable Security Scanning**
   ```bash
   semgrep ci --config=auto
   gitleaks detect --source . --verbose
   ```

## CI Gates & Pass/Fail Criteria

### Required Checks (Block PR on Failure)
- **Secrets Detection**: Zero new secrets (gitleaks/detect-secrets)
- **OWASP Top 10**: No HIGH/CRITICAL findings (semgrep)
- **Dependencies**: No known vulnerabilities >7.0 CVSS
- **Permissions**: Minimal GitHub token scopes

### Warning Checks (Comment but Don't Block)
- **Complexity**: Functions >15 cyclomatic complexity
- **Test Coverage**: <80% for payment flows
- **Bundle Size**: >10% increase requires justification

## Pen-Test Checklist

### Authentication & Authorization
- [ ] Gatekeeper bypass attempts on feature flags
- [ ] JWT token manipulation for pricing arms
- [ ] Session hijacking on bundle timer

### Payment Security  
- [ ] Price manipulation in Stripe checkout
- [ ] Bundle discount stacking exploits
- [ ] Refund abuse patterns

### Data Validation
- [ ] SQL injection in analytics queries
- [ ] XSS in marketplace descriptions  
- [ ] Path traversal in report downloads

### Rate Limiting
- [ ] API endpoint abuse (>100 req/min)
- [ ] Analytics event flooding
- [ ] Webhook replay attacks

## Rollback Procedures

### Dependency Compromise
1. Pin last known good version in package.json
2. Run `pnpm audit fix --force`
3. Regenerate lockfile: `rm pnpm-lock.yaml && pnpm install`
4. Verify with: `semgrep ci --config=auto`

### Secret Exposure
1. Rotate compromised credentials immediately
2. Audit access logs for past 30 days
3. Run BFG cleaner: `bfg --delete-files *.env`
4. Force-push cleaned history (coordinate with team)
5. Update .gitignore and .gitleaks.toml

### Zero-Day Response
1. Enable Cloudflare DDoS protection
2. Implement emergency feature flag kill switch
3. Disable affected experiments via gatekeeper
4. Deploy static maintenance page if needed

## Monitoring & Alerts

### Security Metrics to Track
- Failed authentication attempts (>10/min = alert)
- Feature flag manipulation attempts  
- Unusual refund patterns (>2 std dev)
- Dependency vulnerability count (<5 medium, 0 high)

### Incident Response Contacts
- Security Lead: Review GitHub CODEOWNERS
- Payment Issues: Stripe dashboard admins
- Infrastructure: Cloudflare team members

## Compliance Notes
- PII handling follows GDPR Article 32 (security of processing)
- Payment data never logged (PCI DSS requirement)
- Analytics events use hashed identifiers only
- 30-day retention for security logs

---
*Generated by Claude Security Ops Mode - Treat as living document*